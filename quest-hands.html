<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3 Hand Tracking AR</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        model-viewer {
            width: 100%;
            height: 100%;
        }

        .ar-button {
            background: linear-gradient(45deg, #00d4aa 0%, #00a085 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: 700;
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 212, 170, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .hand-status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            z-index: 1000;
            max-width: 90%;
        }

        .debug-panel {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            max-width: 250px;
            z-index: 1000;
        }

        .instructions {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
            max-width: 90%;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="hand-status" id="handStatus">
        <strong>ü§≤ Checking Hand Tracking...</strong>
    </div>

    <div class="debug-panel" id="debugPanel">
        Debug Info:<br>
        <span id="debugText">Loading...</span>
    </div>

    <model-viewer
        id="hotelModel"
        src="model.glb"
        ar
        ar-modes="webxr"
        camera-controls
        shadow-intensity="1"
        exposure="1"
        camera-orbit="0deg 70deg 15m"
        scale="0.03 0.03 0.03"
        interaction-prompt="none"
        ar-scale="auto"
        ar-placement="floor"
        loading="eager"
        reveal="auto"
        alt="Hotel 3D Model">
        
        <button slot="ar-button" class="ar-button" id="arButton">
            ü§≤ AR with Hands
        </button>
    </model-viewer>

    <div class="instructions" id="instructions">
        <strong>Quest 3 Hand Setup:</strong><br>
        1. Enable Hand Tracking in Quest Settings<br>
        2. Ensure good room lighting<br>
        3. Keep hands visible to cameras
    </div>

    <script>
        const modelViewer = document.getElementById('hotelModel');
        const handStatus = document.getElementById('handStatus');
        const debugPanel = document.getElementById('debugText');
        const arButton = document.getElementById('arButton');
        const instructions = document.getElementById('instructions');

        let debugLog = [];
        let handTrackingSupported = false;

        function addDebug(text) {
            debugLog.push(new Date().toLocaleTimeString() + ': ' + text);
            debugPanel.innerHTML = debugLog.slice(-6).join('<br>');
            console.log('DEBUG:', text);
        }

        // Check hand tracking support
        async function checkHandTracking() {
            addDebug('Checking hand tracking...');
            
            if (!navigator.xr) {
                handStatus.innerHTML = '<strong>‚ùå WebXR Not Available</strong>';
                addDebug('No WebXR support');
                return false;
            }

            try {
                // Check if hand tracking is supported
                const session = await navigator.xr.requestSession('immersive-ar', {
                    optionalFeatures: ['hand-tracking'],
                    requiredFeatures: ['local-floor']
                });
                
                addDebug('AR session created');
                
                // Check for hand tracking
                if (session.inputSources) {
                    addDebug(`Input sources found: ${session.inputSources.length}`);
                    
                    for (let source of session.inputSources) {
                        if (source.hand) {
                            handTrackingSupported = true;
                            addDebug('Hand tracking detected!');
                            break;
                        }
                    }
                }
                
                session.end();
                
                if (handTrackingSupported) {
                    handStatus.innerHTML = '<strong>‚úÖ Hand Tracking Ready!</strong><br>Pinch air to interact';
                    addDebug('Hand tracking confirmed');
                } else {
                    handStatus.innerHTML = '<strong>‚ö†Ô∏è Hand Tracking Limited</strong><br>Enable in Quest Settings';
                    addDebug('Hand tracking not found');
                }
                
                return handTrackingSupported;
                
            } catch (error) {
                addDebug(`Hand tracking check failed: ${error.message}`);
                handStatus.innerHTML = '<strong>‚ùå AR Permission Denied</strong><br>Allow camera access';
                return false;
            }
        }

        // Enhanced AR session handling
        modelViewer.addEventListener('ar-status', (event) => {
            addDebug(`AR status: ${event.detail.status}`);
            
            if (event.detail.status === 'session-started') {
                handStatus.innerHTML = '<strong>üéØ AR Active!</strong><br>Look for your hands';
                instructions.style.display = 'none';
                
                // Monitor hand tracking in AR
                monitorHandTracking();
                
            } else if (event.detail.status === 'failed') {
                handStatus.innerHTML = '<strong>‚ùå AR Failed</strong><br>Check permissions';
                addDebug('AR session failed');
                
            } else if (event.detail.status === 'not-presenting') {
                handStatus.innerHTML = '<strong>ü§≤ Quest 3 Ready</strong><br>Hand tracking available';
                instructions.style.display = 'block';
                addDebug('AR session ended');
            }
        });

        // Monitor hand tracking during AR session
        function monitorHandTracking() {
            if (!modelViewer.ar || !modelViewer.ar.session) return;
            
            const session = modelViewer.ar.session;
            
            // Check input sources for hands
            session.addEventListener('inputsourceschange', (event) => {
                addDebug('Input sources changed');
                
                for (let source of event.session.inputSources) {
                    if (source.hand) {
                        addDebug('Hand input detected!');
                        handStatus.innerHTML = '<strong>üëê Hands Detected!</strong><br>Pinch to interact with hotel';
                    }
                }
            });
            
            // Animation loop to check hands
            function checkHands() {
                if (session.inputSources) {
                    let handsFound = 0;
                    for (let source of session.inputSources) {
                        if (source.hand) handsFound++;
                    }
                    
                    if (handsFound > 0) {
                        handStatus.innerHTML = `<strong>üëê ${handsFound} Hand(s) Tracked!</strong><br>Pinch to grab hotel`;
                    }
                }
                
                if (session && !session.ended) {
                    requestAnimationFrame(checkHands);
                }
            }
            
            checkHands();
        }

        // Model loading
        modelViewer.addEventListener('load', () => {
            addDebug('Hotel model loaded');
        });

        // Initialize
        async function init() {
            addDebug('Initializing...');
            
            // Detect Quest
            const isQuest = /OculusBrowser/.test(navigator.userAgent);
            addDebug(`Quest browser: ${isQuest}`);
            
            if (isQuest) {
                // Quest-specific optimizations
                modelViewer.setAttribute('scale', '0.02 0.02 0.02');
                
                // Check hand tracking support
                // Note: We'll check this when AR starts to avoid permission issues
                handStatus.innerHTML = '<strong>ü•Ω Quest 3 Detected!</strong><br>Tap AR button to check hands';
            } else {
                handStatus.innerHTML = '<strong>üì± Non-Quest Device</strong><br>Limited hand support';
            }
        }

        init();
    </script>
</body>
</html>