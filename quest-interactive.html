<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3 Interactive AR Hotel</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/supermedium/superframe@master/components/hand-tracking-controls/dist/aframe-hand-tracking-controls-component.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #000;
        }
        
        .ui-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-family: Arial;
            z-index: 100;
            max-width: 300px;
        }
        
        .start-ar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 40px;
            background: #00d4aa;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="ui-overlay">
        <h3>üè® Interactive AR Hotel</h3>
        <p><strong>Quest 3 Hand Controls:</strong></p>
        <p>üëê <strong>Grab:</strong> Point at hotel, pinch to grab</p>
        <p>ü§è <strong>Scale:</strong> Grab with both hands, pull apart</p>
        <p>üîÑ <strong>Rotate:</strong> Grab and twist your wrist</p>
        <p>üëÜ <strong>Point:</strong> Explore details up close</p>
    </div>

    <button class="start-ar" onclick="startAR()">
        ü•Ω Start Interactive AR
    </button>

    <a-scene 
        id="arScene"
        embedded
        style="height: 100vh; width: 100vw; display: none;"
        webxr="requiredFeatures: hand-tracking,local-floor"
        background="color: transparent"
        vr-mode-ui="enabled: false">
        
        <!-- Assets -->
        <a-assets>
            <a-asset-item id="hotelModel" src="model.glb"></a-asset-item>
        </a-assets>

        <!-- Hotel Model with Interactions -->
        <a-entity 
            id="hotel"
            gltf-model="#hotelModel"
            position="0 0 -2"
            scale="0.05 0.05 0.05"
            grabbable
            stretchable
            drag-rotate-component
            class="interactive">
        </a-entity>

        <!-- Hand Tracking for Quest 3 -->
        <a-entity 
            id="leftHand" 
            hand-tracking-controls="hand: left; modelStyle: toon"
            pinch-to-grab="hand: left">
        </a-entity>
        
        <a-entity 
            id="rightHand" 
            hand-tracking-controls="hand: right; modelStyle: toon"
            pinch-to-grab="hand: right">
        </a-entity>

        <!-- Camera -->
        <a-camera 
            id="arCamera"
            wasd-controls-enabled="false"
            look-controls-enabled="true">
        </a-camera>

        <!-- Invisible floor for placement reference -->
        <a-plane 
            position="0 -1 0" 
            rotation="-90 0 0" 
            width="10" 
            height="10" 
            material="opacity: 0"
            visible="false">
        </a-plane>
    </a-scene>

    <script>
        let arActive = false;
        let grabbedObject = null;
        let initialGrabDistance = 0;
        let initialScale = { x: 0.05, y: 0.05, z: 0.05 };

        // Register grabbable component
        AFRAME.registerComponent('grabbable', {
            init: function () {
                this.grabbed = false;
                this.grabber = null;
                
                this.el.addEventListener('pinchstarted', (evt) => {
                    if (!this.grabbed) {
                        this.grabbed = true;
                        this.grabber = evt.detail.hand;
                        grabbedObject = this.el;
                        console.log('Hotel grabbed!');
                        
                        // Visual feedback
                        this.el.setAttribute('animation', {
                            property: 'scale',
                            to: '0.055 0.055 0.055',
                            dur: 200
                        });
                    }
                });
                
                this.el.addEventListener('pinchended', (evt) => {
                    if (this.grabbed && this.grabber === evt.detail.hand) {
                        this.grabbed = false;
                        this.grabber = null;
                        grabbedObject = null;
                        console.log('Hotel released!');
                        
                        // Reset visual feedback
                        this.el.setAttribute('animation', {
                            property: 'scale',
                            to: '0.05 0.05 0.05',
                            dur: 200
                        });
                    }
                });
            },
            
            tick: function () {
                if (this.grabbed && this.grabber) {
                    // Move object to hand position
                    const handEl = document.querySelector(`[hand-tracking-controls*="${this.grabber}"]`);
                    if (handEl) {
                        const handPos = handEl.getAttribute('position');
                        const currentPos = this.el.getAttribute('position');
                        
                        // Smooth movement
                        this.el.setAttribute('position', {
                            x: handPos.x,
                            y: handPos.y - 0.2,
                            z: handPos.z
                        });
                    }
                }
            }
        });

        // Register two-hand stretching component
        AFRAME.registerComponent('stretchable', {
            init: function () {
                this.leftHand = null;
                this.rightHand = null;
                this.stretching = false;
                this.initialDistance = 0;
            },
            
            tick: function () {
                const leftHand = document.querySelector('#leftHand');
                const rightHand = document.querySelector('#rightHand');
                
                if (leftHand && rightHand) {
                    const leftPinching = leftHand.components['hand-tracking-controls'].isPinching;
                    const rightPinching = rightHand.components['hand-tracking-controls'].isPinching;
                    
                    if (leftPinching && rightPinching && !this.stretching) {
                        // Start stretching
                        this.stretching = true;
                        const leftPos = leftHand.getAttribute('position');
                        const rightPos = rightHand.getAttribute('position');
                        this.initialDistance = this.calculateDistance(leftPos, rightPos);
                        console.log('Two-hand scaling started!');
                    } else if ((!leftPinching || !rightPinching) && this.stretching) {
                        // Stop stretching
                        this.stretching = false;
                        console.log('Two-hand scaling stopped!');
                    } else if (this.stretching) {
                        // Update scale based on hand distance
                        const leftPos = leftHand.getAttribute('position');
                        const rightPos = rightHand.getAttribute('position');
                        const currentDistance = this.calculateDistance(leftPos, rightPos);
                        const scaleFactor = currentDistance / this.initialDistance;
                        
                        const newScale = scaleFactor * 0.05; // Base scale
                        this.el.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
                    }
                }
            },
            
            calculateDistance: function (pos1, pos2) {
                return Math.sqrt(
                    Math.pow(pos1.x - pos2.x, 2) +
                    Math.pow(pos1.y - pos2.y, 2) +
                    Math.pow(pos1.z - pos2.z, 2)
                );
            }
        });

        // Register pinch-to-grab component for hands
        AFRAME.registerComponent('pinch-to-grab', {
            schema: {
                hand: { type: 'string' }
            },
            
            init: function () {
                this.pinching = false;
                this.wasIntersecting = false;
            },
            
            tick: function () {
                const handControls = this.el.components['hand-tracking-controls'];
                if (!handControls) return;
                
                const isPinching = handControls.isPinching;
                const hotel = document.querySelector('#hotel');
                
                // Check if hand is near hotel
                const handPos = this.el.getAttribute('position');
                const hotelPos = hotel.getAttribute('position');
                const distance = this.calculateDistance(handPos, hotelPos);
                const isNearHotel = distance < 1; // Within 1 meter
                
                if (isPinching && !this.pinching && isNearHotel) {
                    // Start pinch
                    this.pinching = true;
                    hotel.emit('pinchstarted', { hand: this.data.hand });
                } else if (!isPinching && this.pinching) {
                    // End pinch
                    this.pinching = false;
                    hotel.emit('pinchended', { hand: this.data.hand });
                }
            },
            
            calculateDistance: function (pos1, pos2) {
                return Math.sqrt(
                    Math.pow(pos1.x - pos2.x, 2) +
                    Math.pow(pos1.y - pos2.y, 2) +
                    Math.pow(pos1.z - pos2.z, 2)
                );
            }
        });

        // Start AR function
        async function startAR() {
            try {
                const scene = document.querySelector('#arScene');
                scene.style.display = 'block';
                
                // Enter WebXR AR mode
                await scene.enterAR();
                
                // Hide UI
                document.querySelector('.ui-overlay').style.display = 'none';
                document.querySelector('.start-ar').style.display = 'none';
                
                arActive = true;
                console.log('Interactive AR started!');
                
            } catch (error) {
                console.error('AR failed to start:', error);
                alert('AR not available. Make sure you\'re using Quest browser with hand tracking enabled.');
            }
        }

        // Initialize when hand tracking is ready
        document.addEventListener('DOMContentLoaded', () => {
            const scene = document.querySelector('#arScene');
            
            scene.addEventListener('enter-vr', () => {
                console.log('AR mode activated - hand tracking ready!');
            });
            
            scene.addEventListener('exit-vr', () => {
                console.log('AR mode deactivated');
                arActive = false;
                // Show UI again
                document.querySelector('.ui-overlay').style.display = 'block';
                document.querySelector('.start-ar').style.display = 'block';
            });
        });
    </script>
</body>
</html>